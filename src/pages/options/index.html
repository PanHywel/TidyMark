<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TidyMark - 设置</title>
  <link rel="stylesheet" href="index.css">
</head>
  <body>
  <div class="container">
    <!-- 头部 -->
    <header class="header">
      <div class="logo">
        <img src="../../../icons/icon32.svg" alt="TidyMark">
        <h1>TidyMark</h1>
      </div>
      <div class="header-right">
        <div class="version">v1.0.0</div>
        <div class="lang-switch">
          <select id="languageSelect" class="lang-select">
            <option value="zh-CN">简体中文</option>
            <option value="zh-TW">繁體中文</option>
            <option value="en">English</option>
            <option value="ru">Русский</option>
          </select>
        </div>
      </div>
    </header>

    <!-- 导航标签 -->
    <nav class="tabs">
      <button class="tab-btn active" data-tab="organize">整理</button>
      <button class="tab-btn" data-tab="categories" data-i18n="tabs.categories">分类规则</button>
      <button class="tab-btn" data-tab="ai" data-i18n="tabs.ai">AI 配置</button>
      <button class="tab-btn" data-tab="deadlinks" data-i18n="tabs.dead">失效书签</button>
      <button class="tab-btn" data-tab="general">导航</button>
      <button class="tab-btn" data-tab="backup" data-i18n="tabs.help">帮助</button>
    </nav>

    <!-- 常规设置 -->
    <section class="tab-content" id="general">
      <div class="section">
        <h2>导航</h2>
      </div>

      <div class="section">
        <div class="section-header">
          <h3>🧩 导航页小组件</h3>
          <div class="section-description">
            <p>在新标签页显示可选信息模块</p>
          </div>
        </div>
        <div class="setting-item">
          <div class="toggle-row">
            <label class="setting-label">
              <input type="checkbox" id="weatherEnabled">
              <span class="checkmark"></span>
              <span>显示天气信息</span>
            </label>
            <p class="setting-desc inline-hint">开启后，在新标签页顶部显示城市天气</p>
          </div>
        </div>
        <div class="setting-item">
          <label for="weatherCity">城市</label>
          <input type="text" id="weatherCity" placeholder="如：北京、Shanghai、New York">
          <p class="setting-desc">支持中文或英文城市名；留空将使用默认查询</p>
        </div>
        <div class="setting-item">
          <div class="toggle-row">
            <label class="setting-label">
              <input type="checkbox" id="wallpaperEnabled">
              <span class="checkmark"></span>
              <span>显示 Bing 壁纸背景</span>
            </label>
            <p class="setting-desc inline-hint">开启后，新标签页将使用 Bing 每日壁纸作为背景</p>
          </div>
        </div>

        <div class="setting-item">
          <div class="toggle-row">
            <label class="setting-label">
              <input type="checkbox" id="sixtySecondsEnabled">
              <span class="checkmark"></span>
              <span>显示 60s 读懂世界</span>
            </label>
            <p class="setting-desc inline-hint">开启后，在新标签页显示每日「60s读懂世界」新闻摘要</p>
          </div>
        </div>

        <div class="setting-item">
          <label>非聚焦透明度（导航页框）</label>
          <div class="settings-grid">
            <div class="setting-item">
              <label for="searchUnfocusedOpacity">搜索框透明度</label>
              <input type="range" id="searchUnfocusedOpacity" min="0.6" max="1" step="0.02">
              <p class="setting-desc">未聚焦/未悬停时：当前 <span id="searchUnfocusedOpacityValue">—</span>（0.60 - 1.00）</p>
            </div>
            <div class="setting-item">
              <label for="bookmarksUnfocusedOpacity">书签框透明度</label>
              <input type="range" id="bookmarksUnfocusedOpacity" min="0.6" max="1" step="0.02">
              <p class="setting-desc">未悬停时：当前 <span id="bookmarksUnfocusedOpacityValue">—</span>（0.60 - 1.00）</p>
            </div>
            <div class="setting-item">
              <label for="sixtyUnfocusedOpacity">60s 栏目透明度</label>
              <input type="range" id="sixtyUnfocusedOpacity" min="0.6" max="1" step="0.02">
              <p class="setting-desc">未悬停时：当前 <span id="sixtyUnfocusedOpacityValue">—</span>（0.60 - 1.00）</p>
            </div>
          </div>
        </div>

        <div class="setting-item">
          <div class="toggle-row">
            <label class="setting-label">
              <input type="checkbox" id="showBookmarks">
              <span class="checkmark"></span>
              <span>显示书签列表</span>
            </label>
            <p class="setting-desc inline-hint">默认不展示。开启后，新标签页显示书签列表。</p>
          </div>
        </div>
      </div>
    </section>

    <!-- 分类规则 -->
    <section class="tab-content" id="categories">
      <div class="section">
        <div class="section-header">
          <h2 data-i18n="rules.header">分类规则管理</h2>
          <div class="section-actions">
            <button class="btn btn-primary" id="addRule" data-i18n="rules.add">添加规则</button>
            <button class="btn btn-secondary" id="resetRules" data-i18n="rules.reset">重置为默认</button>
          </div>
        </div>
        
        <div class="rules-description">
          <p data-i18n="rules.desc">配置书签的自动分类规则。系统会根据书签的标题和URL中的关键词自动归类到相应的文件夹。</p>
        </div>
        
        <div class="rules-list" id="rulesList">
          <!-- 规则列表将通过JavaScript动态生成 -->
        </div>
        
        <div class="rules-empty" id="rulesEmpty" style="display: none;">
          <div class="empty-state">
            <p data-i18n="rules.empty.text">还没有配置任何分类规则</p>
            <button class="btn btn-primary" onclick="optionsManager.showRuleDialog()" data-i18n="rules.empty.btn">添加第一个规则</button>
          </div>
        </div>
      </div>
    </section>

    <!-- 整理操作 -->
    <section class="tab-content active" id="organize">
      <div class="section">
        <div class="section-header">
          <h2>🔧 整理操作</h2>
      <div class="section-actions">
        <button class="btn btn-outline" id="quickBackupBtn">💾 备份书签</button>
        <button class="btn btn-accent" id="organizeFromSettings" data-i18n="ai.organize.btn">⚡ 自动整理</button>
        <button class="btn btn-outline" id="aiInferOrganizeBtn" data-i18n="ai.infer.btn">🤖 AI 全量归类</button>
      </div>
    </div>
    <div class="section-description">
      <p data-i18n="organize.desc">在此执行书签整理操作：生成预览、AI 优化与确认移动。</p>
    </div>
    

    <!-- 预览内容内嵌容器 -->
    <div id="organizePreview" class="organize-preview" aria-live="polite"></div>
  </div>
</section>

    <!-- AI 配置 -->
    <section class="tab-content" id="ai">
      <div class="section">
        <div class="section-header">
          <h2 data-i18n="ai.header">🤖 AI 分类助手</h2>
          <div class="section-description">
            <p data-i18n="ai.desc">使用人工智能为您的书签提供智能分类建议，让书签管理更加高效</p>
          </div>
        </div>
        
        <div class="setting-item">
          <div class="toggle-row">
            <label class="setting-label">
              <input type="checkbox" id="enableAI">
              <span class="checkmark"></span>
              <span data-i18n="ai.enable">启用 AI 分类建议</span>
            </label>
            <p class="setting-desc inline-hint" data-i18n="ai.enable.desc">开启后，系统将使用 AI 为未分类的书签提供智能分类建议</p>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <h3 data-i18n="ai.service.header">⚙️ 服务配置</h3>
        </div>
        
        <div class="settings-grid">
          <div class="setting-item">
            <label for="aiProvider" data-i18n="ai.provider.label">AI 服务商</label>
            <select id="aiProvider">
              <option value="openai">OpenAI</option>
              <option value="deepseek">DeepSeek</option>
            </select>
            <p class="setting-desc" data-i18n="ai.provider.desc">选择您偏好的 AI 服务提供商</p>
          </div>

          <div class="setting-item">
            <label for="aiModel" data-i18n="ai.model.label">模型选择</label>
            <select id="aiModel">
              <option value="" disabled selected>请选择模型</option>
            </select>
            <p class="setting-desc" data-i18n="ai.model.desc">不同模型的准确性和成本不同</p>
          </div>

          <div class="setting-item">
            <label for="maxTokens" data-i18n="ai.maxTokens.label">最大 Token 数</label>
            <input type="number" id="maxTokens" min="1" step="1" placeholder="8192">
            <p class="setting-desc" data-i18n="ai.maxTokens.desc">控制 AI 响应长度，数值越大成本越高</p>
          </div>
          <div class="setting-item">
            <label for="aiBatchSize" data-i18n="ai.batchSize.label">分批大小</label>
            <input type="number" id="aiBatchSize" min="20" step="10" placeholder="120">
            <p class="setting-desc" data-i18n="ai.batchSize.desc">每次发送给 AI 的条目数量，适当增大可减少请求次数</p>
          </div>

          <div class="setting-item">
            <label for="aiConcurrency" data-i18n="ai.concurrency.label">并发请求数</label>
            <input type="number" id="aiConcurrency" min="1" max="5" step="1" placeholder="3">
            <p class="setting-desc" data-i18n="ai.concurrency.desc">同时进行的 AI 请求数，受服务速率限制影响（建议 ≤ 5）</p>
          </div>
        </div>

        <div class="setting-item">
          <label for="apiKey" data-i18n="ai.apiKey.label">API Key</label>
          <input type="password" id="apiKey" placeholder="请输入您的 API Key" data-i18n-placeholder="ai.apiKey.placeholder">
          <p class="setting-desc" data-i18n="ai.apiKey.desc">🔒 您的 API Key 将安全存储在本地，不会上传到任何服务器</p>
        </div>

        <div class="setting-item">
          <label for="apiEndpoint" data-i18n="ai.apiEndpoint.label">API 端点</label>
          <input type="url" id="apiEndpoint" required placeholder="请输入实际 API 端点（如代理地址）" data-i18n-placeholder="ai.apiEndpoint.placeholder">
          <p class="setting-desc" data-i18n="ai.apiEndpoint.desc">必填：请输入实际 API 端点地址</p>
        </div>

        <div class="setting-item">
          <div class="test-connection">
            <button class="btn btn-secondary" id="testAiConnection" data-i18n="ai.test.btn">
              <span class="loading" style="display: none;"></span>
              🔗 测试连接
            </button>
            <span class="test-result" id="testResult"></span>
          </div>
        </div>

        

        
      </div>

      <div class="section">
        <div class="section-header">
          <h3 data-i18n="pref.header">🎯 分类偏好</h3>
        </div>
        
        <div class="settings-grid">
          <div class="setting-item">
            <label for="classificationLanguage" data-i18n="pref.language.label">分类语言</label>
            <select id="classificationLanguage">
              <option value="zh">中文</option>
              <option value="en">English</option>
              <option value="auto" data-i18n="pref.language.auto">自动检测</option>
            </select>
            <p class="setting-desc" data-i18n="pref.language.desc">AI 生成分类名称的语言</p>
          </div>
        </div>
      </div>
    </section>

    <!-- 失效书签检测（独立标签页） -->
    <section class="tab-content" id="deadlinks">
      <div class="section">
        <div class="section-header">
          <h2 data-i18n="dead.header">🔎 失效书签检测</h2>
          <div class="section-description">
            <p data-i18n="dead.desc">检测不可访问的书签，点击项目可打开页面确认，支持批量删除</p>
          </div>
        </div>
        <div class="scan-actions">
          <label class="setting-label" style="margin-bottom: 8px; display: inline-flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="deadStrictMode">
            <span class="checkmark"></span>
            <span data-i18n="dead.strict.label">严格检测模式</span>
          </label>
          <p class="setting-desc inline-hint" data-i18n="dead.strict.desc">更严格：需多重验证均失败才判定失效，误报更少</p>
          <button class="btn btn-primary" id="deadScanBtn" data-i18n="dead.scan.start">开始检测</button>
          <span id="deadScanProgress" class="inline-hint" aria-live="polite"></span>
        </div>
        <div class="dead-results" id="deadResults" hidden>
          <div class="dead-toolbar">
            <label class="setting-label">
              <input type="checkbox" id="deadSelectAll">
              <span class="checkmark"></span>
              <span data-i18n="dead.selectAll">全选</span>
            </label>
            <button class="btn btn-outline" id="deadMoveBtn" data-i18n="dead.moveSelected">挪到“失效”文件夹</button>
            <button class="btn btn-outline btn-danger" id="deadDeleteBtn" data-i18n="dead.deleteSelected">删除选中</button>
          </div>
          <ul class="list" id="deadResultsList"></ul>
        </div>
      </div>
    </section>

    <!-- 帮助与提示 -->
    <section class="tab-content" id="backup">
      <div class="section">
        <div class="section-header">
          <h2 data-i18n="help.header">💡 帮助与提示</h2>
          <div class="section-description">
            <p data-i18n="help.desc">查看使用说明与备份提示，包括导入、备份和重置</p>
          </div>
        </div>
        
        <div class="data-management-grid">
          <div class="info-card">
            <div class="card-header">
              <h3 data-i18n="help.organize.header">🔧 使用整理功能</h3>
            </div>
            <div class="card-content">
              
              <div class="steps-list">
                <div class="step-item">
                  <span class="step-number">1</span>
                  <span class="step-text" data-i18n="help.organize.step1">点击“⚡ 自动整理”生成预览；如启用 AI，将进行二次优化。</span>
                </div>
                <div class="step-item">
                  <span class="step-number">2</span>
                  <span class="step-text" data-i18n="help.organize.step2">点击“🤖 AI 全量归类”推理新分类并预览，确认后执行移动。</span>
                </div>
                <div class="step-item">
                  <span class="step-number">3</span>
                  <span class="step-text" data-i18n="help.organize.step3">在确认弹窗中查看摘要与分类列表，确认后开始整理。</span>
                </div>
              </div>
            </div>
          </div>

          <div class="info-card">
            <div class="card-header">
              <h3 data-i18n="help.aiFull.header">🤖 AI 全量归类提示</h3>
            </div>
            <div class="card-content">
              <p data-i18n="help.aiFull.desc">AI 全量归类会基于书签内容推理分类并生成预览，您可在预览中调整分类后确认执行移动。请先在「AI 分类助手」中配置服务与模型。</p>
              <p class="warning-text" data-i18n="help.aiFull.warn">建议在执行前先备份书签；该过程可能耗时，取决于书签数量与网络情况。</p>
            </div>
          </div>

          <div class="info-card">
            <div class="card-header">
              <h3 data-i18n="help.import.header">📥 导入书签</h3>
            </div>
            <div class="card-content">
              <p data-i18n="help.import.desc">如需恢复或导入书签，请使用浏览器自带的导入功能：</p>
              <div class="steps-list">
                <div class="step-item">
                  <span class="step-number">1</span>
                  <span class="step-text" data-i18n="help.import.step1">打开 Chrome 设置 → 书签 → 导入书签和设置</span>
                </div>
                <div class="step-item">
                  <span class="step-number">2</span>
                  <span class="step-text" data-i18n="help.import.step2">选择要导入的书签文件</span>
                </div>
                <div class="step-item">
                  <span class="step-number">3</span>
                  <span class="step-text" data-i18n="help.import.step3">确认导入后，重新运行 TidyMark 整理功能</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="info-card">
            <div class="card-header">
              <h3 data-i18n="help.backup.header">💾 备份建议</h3>
            </div>
            <div class="card-content">
              <p data-i18n="help.backup.desc">为了保护您的书签数据，建议：</p>
              <ul class="recommendation-list">
                <li data-i18n="help.backup.rec1">定期使用浏览器的导出功能备份书签</li>
                <li data-i18n="help.backup.rec2">开启 Chrome 同步功能</li>
                <li data-i18n="help.backup.rec3">在整理前先导出当前书签</li>
              </ul>
            </div>
          </div>
          
          <div class="info-card">
            <div class="card-header">
              <h3 data-i18n="help.reset.header">🔄 重置数据</h3>
            </div>
            <div class="card-content">
              <p data-i18n="help.reset.desc">如需清除 TidyMark 的分类数据：</p>
              <div class="reset-actions">
                <button class="btn btn-outline btn-danger" id="resetData" data-i18n="help.reset.btn">清除分类数据</button>
                <p class="warning-text" data-i18n="help.reset.warn">⚠️ 这将清除所有自定义分类规则，但不会影响浏览器书签</p>
              </div>
            </div>
          </div>
        </div>
        <div class="info-card">
          <div class="card-header">
            <h3>📘 关于 TidyMark</h3>
          </div>
          <div class="card-content">
            <div class="about-content">
              <p>TidyMark 是一个智能书签管理扩展，帮助您自动整理和分类书签。</p>
              <div class="feature-list">
                <div class="feature-item">
                  <h4>🔄 智能整理</h4>
                  <p>基于网站内容和用户习惯自动分类书签</p>
                </div>
                <div class="feature-item">
                  <h4>💾 安全备份</h4>
                  <p>支持一键备份，保护您的书签数据</p>
                </div>
                <div class="feature-item">
                  <h4>🎯 自定义规则</h4>
                  <p>创建个性化分类规则，满足不同需求</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- 底部 -->
    <footer class="footer">
      <div class="footer-info">
        <p data-i18n="footer.app">TidyMark - 智能书签管理扩展 v1.0.0</p>
        <p data-i18n="footer.autosave">设置会自动保存，无需手动操作</p>
      </div>
    </footer>
  </div>

  <!-- 隐藏的文件输入 -->
  <input type="file" id="fileInput" accept=".json" style="display: none;">

  <!-- 规则编辑弹框 -->
  <div class="modal-overlay" id="ruleModal" style="display: none;">
    <div class="modal-dialog">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">添加分类规则</h3>
        <button class="modal-close" id="modalClose">&times;</button>
      </div>
      <div class="modal-body">
      <div class="form-group">
          <label for="categoryInput" data-i18n="modal.rule.category.label">分类名称</label>
          <input type="text" id="categoryInput" class="form-input" placeholder="请输入分类名称，如：技术文档、新闻资讯等" data-i18n-placeholder="modal.rule.category.placeholder">
          <div class="input-hint" data-i18n="modal.rule.category.hint">分类名称将用于创建书签文件夹</div>
        </div>
        <div class="form-group">
          <label for="keywordsInput" data-i18n="modal.rule.keywords.label">关键词</label>
          <textarea id="keywordsInput" class="form-textarea" rows="3" placeholder="请输入关键词，用逗号分隔，如：javascript, react, 前端" data-i18n-placeholder="modal.rule.keywords.placeholder"></textarea>
          <div class="input-hint" data-i18n="modal.rule.keywords.hint">系统将根据这些关键词自动匹配网站内容进行分类</div>
        </div>
        <div class="keywords-preview" id="keywordsPreview" style="display: none;">
          <label data-i18n="modal.rule.preview.label">关键词预览：</label>
          <div class="keywords-tags" id="keywordsTags"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="modalCancel" data-i18n="modal.cancel">取消</button>
        <button class="btn btn-primary" id="modalConfirm" data-i18n="modal.confirm">确定</button>
      </div>
    </div>
  </div>

  <script src="../../../services/i18n.js"></script>
  <script src="../../../services/defaultRules.js"></script>
  <script src="index.js"></script>
</body>
</html>